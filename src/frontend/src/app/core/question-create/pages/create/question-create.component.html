<div class="d-flex justify-content mt-3 flex-column min-vh-50">
    <div class="container ">
        <div class="card">
            <div class="card-body">
                <form [formGroup]="questionCreateForm" (ngSubmit)="onSubmit()">

                    <div class="mb-3">
                        <label class="form-label required">Title</label>
                        <input id="title" type="text" class="form-control" formControlName="title" autocomplete="off" />
                        @if (title.invalid && title.touched) {
                        <small class="text-danger fw-medium">*Title is required.</small>
                        }
                    </div>

                    <label class="form-label required">Description</label>
                    <button class="btn btn-primary me-2" type="button" (click)="addImage()">Add Image</button>
                    <button class="btn btn-primary " type="button" (click)="addText()">Add Text</button>

                    <div class="mt-3" formArrayName="inputs">
                        @for (input of inputs.controls; track $index; let i = $index) {
                        <div class="mb-3" [formGroupName]="i">
                            @switch (input.value.type) {
                            @case ('text'){

                            <div class="mb-3">
                              <markdown-editor (onMarkdownContentChange)="onTextChange($event, i)"
                                              formControlName="value" />

                                <button type="button" [disabled]="inputs.length - 1 !== i" class="btn btn-danger"
                                    (click)="removeInput(i)">Remove</button>
                            </div>
                            }
                            @case ('image'){
                            <div class="d-flex align-items-center mb-3">
                                <input type="file" class="form-control me-2 mt-2" formControlName="value"
                                    (change)="onImageChange($event, i)" placeholder="Add image url here..." />

                                <button type="button" [disabled]="inputs.length - 1 !== i" class="btn btn-danger"
                                    (click)="removeInput(i)">Remove</button>
                            </div>
                            }
                            }
                        </div>
                        }
                    </div>

                    <div class="mb-3">
                        @for (input of previews; track $index) {
                        @if (input.type === 'image') {
                            <img src="{{ input.value }}" class="preview-image-size" alt="Image" />
                          <br />
                        }
                        }
                    </div>

                    <div class="mb-3" formArrayName="options">
                        <label class="form-label required">Options</label>
                        <button class="btn btn-info btn-sm me-2" type="button" (click)="addImageOption()">Add
                            Image</button>
                        <button class="btn btn-info btn-sm" type="button" (click)="addTextOption()">Add Text</button>

                        @for (option of options.controls; track $index; let i = $index) {
                        <div class="mb-3" [formGroupName]="i">

                            @switch (option.value.type) {
                            @case ('text'){
                            <div class="d-flex align-items-center mb-3">
                                    <input class="form-check-input me-2" type="checkbox"
                                           formControlName="isCorrect" (change)="selectAsCorrect(i)">

                                    <input type="text" class="form-control me-2 mt-2" formControlName="value"
                                    (blur)="onOptionTextChange($event, i)" placeholder="Add text here..." />

                                  <button type="button" [disabled]="options.length - 1 !== i"
                                  class="btn btn-danger me-2" (click)="removeOption(i)">Remove</button>
                            </div>
                            }
                            @case ('image'){
                            <div class="d-flex align-items-center mb-3">

                                <input class="form-check-input me-2" type="checkbox"
                                       formControlName="isCorrect" (change)="selectAsCorrect(i)" />

                                <input type="file" class="form-control me-2 mt-2" formControlName="value"
                                    (change)="onOptionImageChange($event, i)" placeholder="Add image url here..." />

                                 <button type="button" [disabled]="options.length - 1 !== i"
                                        class="btn btn-danger" (click)="removeOption(i)">Remove</button>
                            </div>
                            }
                            }
                        </div>
                        }
                    </div>

                    <div class="input-group">
                      <div class="mb-3 me-2">
                        <label class="form-label required">Score</label>
                        <input type="number" class="form-control" formControlName="mark" placeholder="1" min="1" max="50"/>
                        @if (mark.touched && mark.invalid){
                          <small class="text-danger fw-medium">*Score is required</small>
                        }
                      </div>

                      <div class="mb-3 me-2">
                        <label class="form-label required">Duration (minutes)</label>
                        <input type="number" class="form-control" formControlName="timeLimit" placeholder="Max 10 Minute" min="1" max="10"/>
                        @if (timeLimit.hasError('required') && timeLimit.touched){
                          <small class="text-danger fw-medium">*TimeLimit is required</small>
                        } @else if (timeLimit.dirty && hasError('timeLimit', 'timeValidator')){
                          <small class="text-danger fw-medium">*TimeLimit must be between 1 and 10</small>
                        }
                      </div>
                    </div>

                    <div class="input-group mb-3">
                      <div class="mb-3">
                        <label class="form-label required">Difficulty Level</label>
                        <input type="number" class="form-control" formControlName="difficulty"
                               min="1" max="5"
                               placeholder="1 to 5">

                        @if (difficulty.hasError('required') && difficulty.touched){
                          <small class="text-danger fw-medium">*Difficulty Level is required</small>
                        } @else if (difficulty.dirty && hasError('difficulty', 'difficultyValidator')){
                          <small class="text-danger fw-medium">*Difficulty Level must be between 1 and 5</small>
                        }

                        <div class="mt-3 form-check form-switch">
                          <input class="form-check-input" type="checkbox" formControlName="required" id="flexSwitchCheckChecked" checked>
                          <label class="form-check-label" for="flexSwitchCheckChecked">Required</label>
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                        <app-select formControlName="tags" label="tag"></app-select>
                        @if (tagsControl.invalid && tagsControl.touched) {
                        <small class="text-danger fw-medium">*Tags are required.</small>
                        }
                    </div>

                    <div class="mb-3">
                        <button appButton class="w-30 me-2" type="submit"
                            [disabled]="questionCreateForm.invalid">Submit</button>

                        <app-preview [previewValue]="previewValue" (notifyCaller)="setPreviewValue()"
                            [disabled]="!this.questionCreateForm.valid">
                        </app-preview>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
